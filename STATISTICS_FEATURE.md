# 数据统计功能文档

## 功能概述

后台数据统计模块提供了完整的销售数据分析功能，包括：

1. **销售概况** - 总订单数、总销售额、销售数量、平均订单金额
2. **产品销售比例** - 展示各产品的销售占比（Top 10）
3. **客户消费排名** - 展示客户消费金额排名（Top 20）
4. **畅销品统计** - 按销售数量排序的畅销产品（Top 10）
5. **滞销品统计** - 长时间未售出的产品
6. **月度报表** - 详细的月度销售数据
7. **报表下载** - 支持Excel格式导出各类报表

## 功能特点

### 1. 可视化图表
- 使用ECharts实现数据可视化
- 饼图展示产品销售比例
- 柱状图展示客户消费排名
- 折线图展示月度销售趋势

### 2. 灵活的筛选条件
- 支持按日期范围筛选
- 支持按年份和月份筛选
- 默认显示当前月份数据

### 3. 多种报表下载
- 月报表（包含概况、每日销售、畅销品、客户排名）
- 产品销售报表
- 客户消费排名报表
- 畅销品报表
- 滞销品报表

## 使用方法

### 访问数据统计页面

1. 登录后台管理系统
2. 点击左侧菜单的"数据统计"

### 查看统计信息

1. **概览卡片** - 顶部显示四个关键指标
2. **产品销售比例图** - 饼图展示Top 10产品的销售占比
3. **客户消费排名图** - 柱状图展示Top 10客户的消费金额
4. **畅销品列表** - 表格展示Top 10畅销产品
5. **滞销品列表** - 表格展示滞销产品（30天未售出或有库存但从未售出）
6. **月度销售趋势** - 折线图展示年度12个月的订单数和销售额

### 筛选数据

1. 在页面顶部的筛选表单中选择日期范围或年月
2. 点击"查询"按钮刷新统计图表和数据

### 下载报表

1. **月报表** - 点击"导出月报表"按钮，选择年份和月份
2. **产品销售报表** - 点击"产品销售报表"按钮
3. **客户消费排名** - 点击"客户消费排名"按钮
4. **畅销品报表** - 点击"畅销品报表"按钮
5. **滞销品报表** - 点击"滞销品报表"按钮

报表将自动下载为Excel文件。

## 技术实现

### 后端服务

**文件**: `app/services/statistics_service.py`

主要方法：
- `get_sales_overview()` - 获取销售概况
- `get_product_sales_ratio()` - 获取产品销售比例
- `get_customer_ranking()` - 获取客户消费排名
- `get_best_selling_products()` - 获取畅销品
- `get_slow_moving_products()` - 获取滞销品
- `get_monthly_statistics()` - 获取月度统计
- `get_yearly_summary()` - 获取年度汇总
- `export_to_excel()` - 导出数据到Excel
- `export_monthly_report()` - 导出月报表
- `export_product_sales()` - 导出产品销售报表
- `export_customer_ranking()` - 导出客户排名报表

### 前端页面

**文件**: `app/templates/admin/statistics.html`

主要功能：
- 响应式布局，适配不同屏幕尺寸
- 使用ECharts绘制交互式图表
- AJAX无刷新数据加载
- 文件下载功能

### 路由接口

**文件**: `app/routes/admin.py`

主要路由：
- `GET /admin/statistics` - 数据统计页面
- `GET /admin/statistics/export/monthly/<year>/<month>` - 导出月报表
- `GET /admin/statistics/export/product-sales` - 导出产品销售报表
- `GET /admin/statistics/export/customer-ranking` - 导出客户排名报表
- `GET /admin/statistics/export/best-selling` - 导出畅销品报表
- `GET /admin/statistics/export/slow-moving` - 导出滞销品报表

## 数据统计规则

### 滞销品判定标准
- 30天前最后销售的产品
- 或从未售出但有库存的产品

### 销售统计范围
- 仅统计已确认、已发货、已完成的订单
- 排除待处理和已取消的订单

### 图表展示
- 饼图：展示Top 10产品销售占比
- 柱状图：展示Top 10客户消费金额
- 折线图：展示12个月的订单数和销售额趋势

## 依赖库

- Flask - Web框架
- Flask-SQLAlchemy - ORM
- pandas - 数据处理
- openpyxl - Excel文件操作
- ECharts - 图表库（前端）

## 注意事项

1. **数据权限** - 仅登录用户可访问数据统计功能
2. **数据缓存** - 当前版本不使用缓存，每次查询实时计算
3. **数据量** - 对于大量数据，建议使用分页或限制返回数量
4. **文件导出** - 导出的Excel文件保存在临时目录`/tmp`，需要定期清理

## 未来优化建议

1. **性能优化** - 添加数据库索引，优化查询性能
2. **数据缓存** - 使用Redis缓存统计结果
3. **更多图表** - 添加更多类型的图表（雷达图、漏斗图等）
4. **自定义报表** - 支持用户自定义报表字段和格式
5. **定时任务** - 支持定时生成报表并发送邮件
6. **PDF导出** - 支持导出PDF格式报表
7. **数据对比** - 支持同比、环比分析
