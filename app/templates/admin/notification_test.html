{% extends "admin/base.html" %}

{% block title %}通知测试{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-bell"></i> 通知测试</h2>

<div class="row">
    <!-- 邮件测试 -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-envelope"></i> 邮件通知测试</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    配置说明：请在 config.py 中设置以下邮件配置
                    <pre class="mt-2 mb-0 small">
MAIL_SERVER = 'smtp.qq.com'
MAIL_PORT = 465
MAIL_USE_SSL = True
MAIL_USERNAME = 'your_email@qq.com'
MAIL_PASSWORD = 'your_password'</pre>
                </div>
                
                <form id="emailTestForm">
                    <div class="mb-3">
                        <label class="form-label">收件人邮箱</label>
                        <input type="email" class="form-control" id="emailTo" required
                               placeholder="test@example.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">邮件主题</label>
                        <input type="text" class="form-control" id="emailSubject" required
                               value="测试邮件">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">邮件内容</label>
                        <textarea class="form-control" id="emailBody" rows="4" required>
这是一封测试邮件，由日用产品批发零售系统发送。

如果您收到此邮件，说明邮件配置正确！</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" id="sendEmailBtn">
                        <i class="bi bi-send"></i> 发送测试邮件
                    </button>
                </form>
                
                <div id="emailResult" class="mt-3"></div>
            </div>
        </div>
    </div>
    
    <!-- 短信测试 -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-phone"></i> 短信通知测试</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    配置说明：请在 config.py 中设置以下短信配置
                    <pre class="mt-2 mb-0 small">
SMS_API_URL = 'https://api.example.com/sms'
SMS_API_KEY = 'your_api_key'
SMS_SIGN_NAME = '公司名称'</pre>
                </div>
                
                <form id="smsTestForm">
                    <div class="mb-3">
                        <label class="form-label">收件人手机号</label>
                        <input type="tel" class="form-control" id="smsTo" required
                               placeholder="13800138000">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">短信内容</label>
                        <textarea class="form-control" id="smsBody" rows="4" required
                               maxlength="70">【公司名称】这是一条测试短信，由日用产品批发零售系统发送。</textarea>
                        <small class="text-muted">最多70个字符（含签名）</small>
                    </div>
                    <button type="submit" class="btn btn-success" id="sendSmsBtn">
                        <i class="bi bi-send"></i> 发送测试短信
                    </button>
                </form>
                
                <div id="smsResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-question-circle"></i> 常用邮箱SMTP配置</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>邮箱服务商</th>
                                <th>SMTP服务器</th>
                                <th>端口</th>
                                <th>SSL/TLS</th>
                                <th>获取密码方式</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>QQ邮箱</td>
                                <td>smtp.qq.com</td>
                                <td>465 (SSL) / 587 (TLS)</td>
                                <td>SSL</td>
                                <td>邮箱设置 -> 账户 -> POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务 -> 开启服务 -> 生成授权码</td>
                            </tr>
                            <tr>
                                <td>163邮箱</td>
                                <td>smtp.163.com</td>
                                <td>465 (SSL) / 994 (SSL)</td>
                                <td>SSL</td>
                                <td>邮箱设置 -> POP3/SMTP/IMAP -> 开启服务 -> 获取授权码</td>
                            </tr>
                            <tr>
                                <td>Gmail</td>
                                <td>smtp.gmail.com</td>
                                <td>465 (SSL) / 587 (TLS)</td>
                                <td>SSL</td>
                                <td>Google账户 -> 安全性 -> 两步验证 -> 应用专用密码</td>
                            </tr>
                            <tr>
                                <td>Outlook</td>
                                <td>smtp.office365.com</td>
                                <td>587 (TLS)</td>
                                <td>TLS</td>
                                <td>使用常规密码或两步验证的应用专用密码</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 邮件测试
$('#emailTestForm').on('submit', function(e) {
    e.preventDefault();
    
    const btn = $('#sendEmailBtn');
    btn.prop('disabled', true).html('<i class="bi bi-spinner spinner-border"></i> 发送中...');
    
    $.ajax({
        url: '/api/admin/test-notification/email',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            to: $('#emailTo').val(),
            subject: $('#emailSubject').val(),
            body: $('#emailBody').val()
        }),
        success: function(response) {
            $('#emailResult').html('<div class="alert alert-success"><i class="bi bi-check-circle"></i> ' + response.message + '</div>');
        },
        error: function(xhr) {
            const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : '发送失败';
            $('#emailResult').html('<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ' + errorMsg + '</div>');
        },
        complete: function() {
            btn.prop('disabled', false).html('<i class="bi bi-send"></i> 发送测试邮件');
        }
    });
});

// 短信测试
$('#smsTestForm').on('submit', function(e) {
    e.preventDefault();
    
    const btn = $('#sendSmsBtn');
    btn.prop('disabled', true).html('<i class="bi bi-spinner spinner-border"></i> 发送中...');
    
    $.ajax({
        url: '/api/admin/test-notification/sms',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            to: $('#smsTo').val(),
            body: $('#smsBody').val()
        }),
        success: function(response) {
            $('#smsResult').html('<div class="alert alert-success"><i class="bi bi-check-circle"></i> ' + response.message + '</div>');
        },
        error: function(xhr) {
            const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : '发送失败';
            $('#smsResult').html('<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ' + errorMsg + '</div>');
        },
        complete: function() {
            btn.prop('disabled', false).html('<i class="bi bi-send"></i> 发送测试短信');
        }
    });
});
</script>
{% endblock %}
