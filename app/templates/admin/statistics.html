{% extends "admin/base.html" %}

{% block title %}数据统计{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 350px;
        margin-bottom: 20px;
    }
    .nav-tabs .nav-link.active {
        background-color: #0d6efd;
        color: white;
    }
    .stat-card {
        transition: transform 0.2s;
        cursor: pointer;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .ranking-item {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    .ranking-item:last-child {
        border-bottom: none;
    }
    .ranking-badge {
        width: 30px;
        height: 30px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-weight: bold;
    }
    .rank-1 { background-color: #ffd700; color: #fff; }
    .rank-2 { background-color: #c0c0c0; color: #fff; }
    .rank-3 { background-color: #cd7f32; color: #fff; }
</style>
{% endblock %}

{% block content %}
<h2 class="mb-4">
    <i class="bi bi-graph-up"></i> 数据统计
</h2>

<!-- 筛选条件 -->
<div class="card mb-4">
    <div class="card-body">
        <form id="filterForm" class="row g-3">
            <div class="col-md-3">
                <label for="startDate" class="form-label">开始日期</label>
                <input type="date" class="form-control" id="startDate" name="start_date">
            </div>
            <div class="col-md-3">
                <label for="endDate" class="form-label">结束日期</label>
                <input type="date" class="form-control" id="endDate" name="end_date">
            </div>
            <div class="col-md-2">
                <label for="yearSelect" class="form-label">年份</label>
                <select class="form-select" id="yearSelect" name="year">
                    {% for y in range(2023, 2025) %}
                    <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="monthSelect" class="form-label">月份</label>
                <select class="form-select" id="monthSelect" name="month">
                    <option value="">全部</option>
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if m == current_month %}selected{% endif %}>{{ m }}月</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> 查询
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 概览卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">总订单数</h6>
                        <h3 id="totalOrders">{{ stats.overview.total_orders }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-receipt" style="font-size: 2.5rem; opacity: 0.7;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">总销售额</h6>
                        <h3 id="totalSales">¥{{ "%.0f"|format(stats.overview.total_sales) }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-currency-yen" style="font-size: 2.5rem; opacity: 0.7;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">销售数量</h6>
                        <h3 id="totalQuantity">{{ stats.overview.total_quantity }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-cart" style="font-size: 2.5rem; opacity: 0.7;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">平均订单金额</h6>
                        <h3 id="avgOrderAmount">¥{{ "%.2f"|format(stats.overview.avg_order_amount) }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-calculator" style="font-size: 2.5rem; opacity: 0.7;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 统计图表 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> 产品销售比例 (Top 10)</h5>
            </div>
            <div class="card-body">
                <div id="productPieChart" class="chart-container"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> 客户消费排名 (Top 10)</h5>
            </div>
            <div class="card-body">
                <div id="customerBarChart" class="chart-container"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-trophy"></i> 畅销品 (Top 10)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>产品名称</th>
                                <th>销售数量</th>
                                <th>销售额</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in stats.best_selling %}
                            <tr>
                                <td>
                                    <span class="ranking-badge rank-{{ loop.index }}">{{ loop.index }}</span>
                                </td>
                                <td>{{ item.product_name }}</td>
                                <td class="text-primary">{{ item.total_quantity }}</td>
                                <td class="text-danger">¥{{ "%.2f"|format(item.total_sales) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> 滞销品</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>产品名称</th>
                                <th>库存</th>
                                <th>最后销售</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in stats.slow_moving %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ item.product_name }}</td>
                                <td class="text-warning">{{ item.stock }}</td>
                                <td class="text-muted">{{ item.last_sale_date }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 月度报表 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-calendar3"></i> 月度销售趋势</h5>
                <button class="btn btn-sm btn-success" onclick="downloadMonthlyReport()">
                    <i class="bi bi-download"></i> 导出月报表
                </button>
            </div>
            <div class="card-body">
                <div id="monthlyLineChart" class="chart-container" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- 报表下载 -->
<div class="card mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-file-earmark-excel"></i> 报表下载</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3 mb-3">
                <button class="btn btn-outline-primary w-100" onclick="downloadProductSales()">
                    <i class="bi bi-download"></i> 产品销售报表
                </button>
            </div>
            <div class="col-md-3 mb-3">
                <button class="btn btn-outline-success w-100" onclick="downloadCustomerRanking()">
                    <i class="bi bi-download"></i> 客户消费排名
                </button>
            </div>
            <div class="col-md-3 mb-3">
                <button class="btn btn-outline-info w-100" onclick="downloadBestSelling()">
                    <i class="bi bi-download"></i> 畅销品报表
                </button>
            </div>
            <div class="col-md-3 mb-3">
                <button class="btn btn-outline-warning w-100" onclick="downloadSlowMoving()">
                    <i class="bi bi-download"></i> 滞销品报表
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
    // 产品销售饼图
    const productPieChart = echarts.init(document.getElementById('productPieChart'));
    const productData = {{ stats.product_sales_ratio | tojson }};
    
    productPieChart.setOption({
        tooltip: {
            trigger: 'item',
            formatter: '{b}: ¥{c} ({d}%)'
        },
        legend: {
            orient: 'vertical',
            left: 'left',
            type: 'scroll'
        },
        series: [{
            name: '产品销售',
            type: 'pie',
            radius: ['40%', '70%'],
            avoidLabelOverlap: false,
            itemStyle: {
                borderRadius: 10,
                borderColor: '#fff',
                borderWidth: 2
            },
            label: {
                show: false,
                position: 'center'
            },
            emphasis: {
                label: {
                    show: true,
                    fontSize: 20,
                    fontWeight: 'bold'
                }
            },
            labelLine: {
                show: false
            },
            data: productData.map(item => ({
                name: item.product_name,
                value: item.total_sales
            }))
        }]
    });

    // 客户消费柱状图
    const customerBarChart = echarts.init(document.getElementById('customerBarChart'));
    const customerData = {{ stats.customer_ranking | tojson }};
    
    customerBarChart.setOption({
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            },
            formatter: '{b}: ¥{c}'
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: customerData.slice(0, 10).map(item => item.customer_name),
            axisLabel: {
                interval: 0,
                rotate: 30
            }
        },
        yAxis: {
            type: 'value',
            name: '消费金额(元)'
        },
        series: [{
            name: '消费金额',
            type: 'bar',
            data: customerData.slice(0, 10).map(item => item.total_amount),
            itemStyle: {
                color: '#0d6efd'
            }
        }]
    });

    // 月度趋势折线图
    const monthlyLineChart = echarts.init(document.getElementById('monthlyLineChart'));
    const monthlyData = {{ stats.monthly_sales | tojson }};
    
    monthlyLineChart.setOption({
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['订单数', '销售额']
        },
        xAxis: {
            type: 'category',
            data: monthlyData.map(item => item.month + '月'),
            boundaryGap: false
        },
        yAxis: [
            {
                type: 'value',
                name: '订单数',
                position: 'left'
            },
            {
                type: 'value',
                name: '销售额(元)',
                position: 'right'
            }
        ],
        series: [
            {
                name: '订单数',
                type: 'line',
                data: monthlyData.map(item => item.order_count),
                smooth: true,
                itemStyle: {
                    color: '#0d6efd'
                }
            },
            {
                name: '销售额',
                type: 'line',
                yAxisIndex: 1,
                data: monthlyData.map(item => item.total_sales),
                smooth: true,
                itemStyle: {
                    color: '#198754'
                }
            }
        ]
    });

    // 窗口大小改变时重新渲染图表
    window.addEventListener('resize', function() {
        productPieChart.resize();
        customerBarChart.resize();
        monthlyLineChart.resize();
    });

    // 表单提交
    document.getElementById('filterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const year = document.getElementById('yearSelect').value;
        const month = document.getElementById('monthSelect').value;
        
        const url = new URL(window.location.href);
        if (startDate) url.searchParams.set('start_date', startDate);
        if (endDate) url.searchParams.set('end_date', endDate);
        if (year) url.searchParams.set('year', year);
        if (month) url.searchParams.set('month', month);
        
        window.location.href = url.toString();
    });

    // 下载月报表
    function downloadMonthlyReport() {
        const year = document.getElementById('yearSelect').value;
        const month = document.getElementById('monthSelect').value;
        const url = `/admin/statistics/export/monthly/${year}/${month}`;
        window.location.href = url;
    }

    // 下载产品销售报表
    function downloadProductSales() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        let url = '/admin/statistics/export/product-sales';
        if (startDate && endDate) {
            url += `?start_date=${startDate}&end_date=${endDate}`;
        }
        window.location.href = url;
    }

    // 下载客户排名
    function downloadCustomerRanking() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        let url = '/admin/statistics/export/customer-ranking';
        if (startDate && endDate) {
            url += `?start_date=${startDate}&end_date=${endDate}`;
        }
        window.location.href = url;
    }

    // 下载畅销品报表
    function downloadBestSelling() {
        const year = document.getElementById('yearSelect').value;
        const month = document.getElementById('monthSelect').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        let url = '/admin/statistics/export/best-selling';
        const params = new URLSearchParams();
        if (year) params.append('year', year);
        if (month) params.append('month', month);
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        window.location.href = url;
    }

    // 下载滞销品报表
    function downloadSlowMoving() {
        window.location.href = '/admin/statistics/export/slow-moving';
    }
</script>
{% endblock %}
